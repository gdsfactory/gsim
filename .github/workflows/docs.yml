name: Docs
on:
  push:
    branches:
      - main
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
    paths:
      - "src/**"
      - "nbs/**"
      - "docs/**"
      - "mkdocs.yml"
  workflow_dispatch:
env:
  GFP_API_KEY: ${{ secrets.GFP_API_KEY }}
jobs:
  # Discover all notebooks and output as JSON array for the matrix
  list-notebooks:
    runs-on: ubuntu-latest
    outputs:
      notebooks: ${{ steps.find.outputs.notebooks }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
      - name: Find notebooks
        id: find
        run: |
          nbs=$(find nbs -name "*.ipynb" -not -path "*/.ipynb_checkpoints/*" | sort | jq -Rsc 'split("\n") | map(select(. != ""))')
          echo "notebooks=$nbs" >> "$GITHUB_OUTPUT"
  # Run each notebook in parallel
  run-notebook:
    runs-on: ubuntu-latest
    needs: list-notebooks
    strategy:
      matrix:
        notebook: ${{ fromJson(needs.list-notebooks.outputs.notebooks) }}
      fail-fast: false
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
      - name: Install UV
        uses: astral-sh/setup-uv@v5
      - name: Install Just
        uses: taiki-e/install-action@just
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libglu1-mesa libosmesa6 xvfb
      - name: Create environment
        run: just dev
      - name: Install ubcpdk (unreleased)
        run: uv pip install ubcpdk@git+https://github.com/gdsfactory/ubc.git
      - name: Create ipykernel
        run: uv run --no-sync python -m ipykernel install --user --name gsim
      - name: Run notebook
        run: |
          dir=$(dirname "${{ matrix.notebook }}")
          filename=$(basename "${{ matrix.notebook }}")
          cd "$dir" && xvfb-run -a uv run --no-sync papermill "$filename" "$filename" -k gsim
      - name: Upload executed notebook
        uses: actions/upload-artifact@v4
        with:
          name: nb-${{ hashFiles(matrix.notebook) }}
          path: ${{ matrix.notebook }}
          retention-days: 1
  build:
    name: Build Docs
    runs-on: ubuntu-latest
    needs: run-notebook
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
      - name: Install UV
        uses: astral-sh/setup-uv@v5
      - name: Install Just
        uses: taiki-e/install-action@just
      - name: Install svgbob
        run: cargo install svgbob_cli
      - name: Create environment
        run: just dev
      - name: Install ubcpdk (unreleased)
        run: uv pip install ubcpdk@git+https://github.com/gdsfactory/ubc.git
      - name: Download all notebook artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: nb-*
          merge-multiple: true
          path: nbs
      - name: Build docs
        run: |
          just nbdocs
          just docs
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
  pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref_name, 'a') && !contains(github.ref_name, 'b') && !contains(github.ref_name, 'rc') && !contains(github.ref_name, 'post')))
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
